////INTENTO DE TEMPERATURA CRITICA VARIABLE
////REGISTRO SOLO UNO PERO FUNCIONA
////fallo tcrit es que lo pase como tipo char



#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <locale.h>
#include <conio.h>
#include "SerialClass/SerialClass.h"
#define MAX_BUFFER 200
#define PAUSA_MS 200
#define LONGCAD 50
#define N 100
/*
typedef struct
{
	int dia;
	int mes;
	int anio;
}fecha;*/

typedef struct
{
	int dia;
	int mes;
	int anio;
	int hora;
	int minutos;
	float temperatura[N];
}registro;

// Funciones prototipo
int menu(void);
void verifica_sensores(Serial*, char*);
registro monitorizar_sensor_temperatura(Serial*, int*);
void activar_alarma_temperatura(Serial* Arduino);
void comprobar_mensajes(Serial*);
float leer_sensor_temperatura(Serial*);
int Enviar_y_Recibir(Serial*, const char*, char*);
float float_from_cadena(char* cadena);
void registrar_temperatura(registro*, int);
void escribir_fichero_registro(registro* r, int nr, int nt);
void cambiar_t_crit(Serial* Arduino);
//void leer_fichero_registro(registro t[], int* ptemp, int longitud);
//registro leer_datos_temperatura();
//int mostrar_datos_temperatura(registro r);

int main(void)
{
	Serial* Arduino;
	char puerto[] = "COM3"; // Puerto serie al que está conectado Arduino
	int opcion_menu, nr = 0, nt = 0;

	registro r; //<------!!!!!!!!!!!!!!!



	setlocale(LC_ALL, "es-ES");
	Arduino = new Serial((char*)puerto);
	do
	{
		comprobar_mensajes(Arduino);								////////1////////
		opcion_menu = menu();										////////2////////
		switch (opcion_menu)
		{
		case 0: break;
		case 1:
			verifica_sensores(Arduino, puerto);
			break;
		case 2:
			r = monitorizar_sensor_temperatura(Arduino, &nt);
			nr++;
			break;
		case 3:
			activar_alarma_temperatura(Arduino);
			break;
		case 4:
			escribir_fichero_registro(&r, nr, nt);
			break;
		case 5:
			cambiar_t_crit(Arduino);
			break;
		case 6:
			break;
		default: printf("\nOpción incorrecta\n");
		}
	} while (opcion_menu != 6);
	return 0;
}



int menu(void)														////////2////////
{
	static int opcion = -1;

	if (opcion != 0)
	{
		printf("\n");
		printf("Menú Principal\n");
		printf("==============\n");
		printf("1 - Verificar sensores.\n");
		printf("2 - Monitorizar sensores.\n");
		printf("3 - Activar/Desactivar alarma por distancia\n");
		printf("4 - Generar fichero de temperaturas\n");
		printf("5 - Cambiar temperatura crítica\n");
		printf("6 - Salir de la aplicación\n");
		printf("Opción:");
	}

	if (_kbhit())
	{
		opcion = (int)_getch() - '0';
		printf("%d\n", opcion);
	}
	else
		opcion = 0;

	return opcion;
}




void verifica_sensores(Serial* Arduino, char* port)								////////2.1////////
{
	float temperatura;

	if (Arduino->IsConnected())
	{
		temperatura = leer_sensor_temperatura(Arduino);
		if (temperatura != -1)
			printf("\nTemperatura: %f\n", temperatura);
	}
	else
	{
		printf("\nNo se ha podido conectar con Arduino.\n");
		printf("Revise la conexión, el puerto %s y desactive el monitor serie del IDE de Arduino.\n", port);
	}
}




float leer_sensor_temperatura(Serial* Arduino)								////////2.2.1////////o///////2.1.1/////
{
	float temperatura;
	int bytesRecibidos;
	char mensaje_recibido[MAX_BUFFER];

	bytesRecibidos = Enviar_y_Recibir(Arduino, "GET_TEMPERATURA\n", mensaje_recibido);

	if (bytesRecibidos <= 0)
	{
		printf("\nNo se ha recibido respuesta a la petición\n");
		temperatura = -1;
	}
	else
	{
		printf("\nLa respuesta recibida tiene %d bytes. Recibido=%s\n", bytesRecibidos, mensaje_recibido);
		temperatura = float_from_cadena(mensaje_recibido);
	}
	return temperatura;
}



float float_from_cadena(char* cadena)							/////////2.2.1.2 o 2.1.1.2//////////////
{
	float numero = 0;
	int i, divisor = 10, estado = 0;


	for (i = 0; cadena[i] != '\0' && estado != 3 && i < MAX_BUFFER; i++)
		switch (estado)
		{
		case 0:// Antes del número
			if (cadena[i] >= '0' && cadena[i] <= '9')
			{
				numero = cadena[i] - '0';
				estado = 1;
			}
			break;
		case 1:// Durante el número
			if (cadena[i] >= '0' && cadena[i] <= '9')
				numero = numero * 10 + cadena[i] - '0';
			else
				if (cadena[i] == '.' || cadena[i] == ',')
					estado = 2;
				else
					estado = 3;
			break;
		case 2: // Parte decimal
			if (cadena[i] >= '0' && cadena[i] <= '9')
			{
				numero = numero + (float)(cadena[i] - '0') / divisor;
				divisor *= 10;
			}
			else
				estado = 3;
			break;
		}
	return numero;
}



int Enviar_y_Recibir(Serial* Arduino, const char* mensaje_enviar, char* mensaje_recibir)        //////2.2.1.1 o 2.1.1.1/////
{																									////////2.3.1////////
	int bytes_recibidos = 0, total = 0;
	int intentos = 0, fin_linea = 0;


	Arduino->WriteData((char*)mensaje_enviar, strlen(mensaje_enviar));
	Sleep(PAUSA_MS);

	bytes_recibidos = Arduino->ReadData(mensaje_recibir, sizeof(char) * MAX_BUFFER - 1);

	while ((bytes_recibidos > 0 || intentos < 5) && fin_linea == 0)
	{
		if (bytes_recibidos > 0)
		{
			total += bytes_recibidos;
			if (mensaje_recibir[total - 1] == 13 || mensaje_recibir[total - 1] == 10)
				fin_linea = 1;
		}
		else
			intentos++;
		Sleep(PAUSA_MS);
		bytes_recibidos = Arduino->ReadData(mensaje_recibir + total, sizeof(char) * MAX_BUFFER - 1);
	}
	if (total > 0)
		mensaje_recibir[total - 1] = '\0';

	//printf("LOG: %d bytes -> %s\nIntentos=%d - EOLN=%d\n", total, mensaje_recibir,intentos,fin_linea);
	return total;
}



registro monitorizar_sensor_temperatura(Serial* Arduino, int* nt)								////////2.2////////
{
	float frecuencia, temperatura;
	//int i=0;
	char tecla;
	registro r;
	int i = 0;
	do
	{
		printf("Establezca frecuencia de muestreo (0,5 Hz - 2,0 Hz):");
		scanf_s("%f", &frecuencia);
	} while (frecuencia < 0.5 || frecuencia>2.0);

	printf("Pulse una tecla para finalizar la monitorización\n");
	registrar_temperatura(&r, i);
	do
	{
		if (Arduino->IsConnected())
		{
			temperatura = leer_sensor_temperatura(Arduino);
			if (temperatura != -1)
			{
				printf("%.2f ", temperatura);
				r.temperatura[i] = temperatura;
				i++;
				*nt = i;
			}

			else
				printf("XXX ");
		}
		else
			printf("\nNo se ha podido conectar con Arduino.\n");
		if ((1 / frecuencia) * 1000 > PAUSA_MS)
			Sleep((1 / frecuencia) * 1000 - PAUSA_MS);
	} while (_kbhit() == 0);
	tecla = _getch();
	return r;
}




void activar_alarma_temperatura(Serial* Arduino)								////////2.3////////
{
	int bytesRecibidos;
	char mensaje_recibido[MAX_BUFFER];

	bytesRecibidos = Enviar_y_Recibir(Arduino, "SET_MODO_ALARMA\n", mensaje_recibido);
	if (bytesRecibidos <= 0)
		printf("\nNo se ha recibido confirmación\n");
	else
		printf("\n%s\n", mensaje_recibido);
}




void comprobar_mensajes(Serial* Arduino)									////////1////////
{
	int bytesRecibidos, total = 0;
	char mensaje_recibido[MAX_BUFFER];

	bytesRecibidos = Arduino->ReadData(mensaje_recibido, sizeof(char) * MAX_BUFFER - 1);
	while (bytesRecibidos > 0)
	{
		Sleep(PAUSA_MS);
		total += bytesRecibidos;
		bytesRecibidos = Arduino->ReadData(mensaje_recibido + total, sizeof(char) * MAX_BUFFER - 1);
	}
	if (total > 0)
	{
		mensaje_recibido[total - 1] = '\0';
		printf("\nMensaje recibido: %s\n", mensaje_recibido);
	}
}






void cambiar_t_crit(Serial* Arduino)								////////2.3////////
{
	int bytesRecibidos, i = 0;
	char t_crit[MAX_BUFFER];
	char mensaje_recibido_t[MAX_BUFFER];

	bytesRecibidos = Enviar_y_Recibir(Arduino, "CAMBIAR_T_CRIT\n", mensaje_recibido_t);
	if (bytesRecibidos <= 0)
		printf("\nNo se ha recibido confirmación\n");
	else
	{
		printf("\n%s\n", mensaje_recibido_t);
		scanf_s("%c", &t_crit[i]);
		while (t_crit[i] != '\n')
		{
			i++;
			scanf_s("%c", &t_crit[i]);
		}
		//scanf_s("%s\n", t_crit[MAX_BUFFER]);
		//gets_s(t_crit,MAX_BUFFER);
		bytesRecibidos = Enviar_y_Recibir(Arduino, t_crit, mensaje_recibido_t);
		//Arduino->WriteData((float)t_crit, sizeof(float)*1);

		if (bytesRecibidos <= 0)
			printf("\nNo se ha recibido confirmación\n");
		else
			printf("\n%s\n", mensaje_recibido_t);
	}
}



void escribir_fichero_registro(registro* r, int nr, int nt)
{
	int i, j;
	FILE* pf;
	errno_t e;
	e = fopen_s(&pf, "Temperatura.txt", "wt");
	if (e == 0) // Si el fichero se ha podido crear
	{
		fprintf(pf, "Numero de registros: %d\n", nr); // Se graba en el fichero el número de usuarios
		fprintf(pf, "Numero de temperaturas en registro %d: %d\n", nr + 1, nt);
		for (i = 0; i < nr; i++)
		{
			fprintf(pf, "%d\n", (r + i)->dia);
			//fprintf(pf, "%d\n", (r+i)->f.dia);
			fprintf(pf, "%d\n", (r + i)->mes);
			fprintf(pf, "%d\n", (r + i)->anio);
			fprintf(pf, "%d\n", (r + i)->hora);
			fprintf(pf, "%d\n", (r + i)->minutos);
			for (j = 0; j < nt; j++)
			{
				fprintf(pf, "%.3f\n", (r + i)->temperatura[j]);
			}
		}
		fclose(pf);
	}
	else
		printf("Se ha producido un problema a la hora de grabar el fichero de usuarios\n");
	//return err;
}







void registrar_temperatura(registro* r, int i)
{
	char intro;

	printf("Nuevo registro\n");
	printf("Dia:");
	scanf_s("%d", &r->dia);
	printf("Mes:");
	scanf_s("%d", &r->mes);
	printf("Anio:");
	scanf_s("%d", &r->anio);
	printf("hora:");
	scanf_s("%d", &r->hora);
	printf("minutos:");
	scanf_s("%d", &r->minutos);
	//printf("Temperatura:");
	//scanf_s("%d", &r.temperatura);
	intro = getchar();
}
